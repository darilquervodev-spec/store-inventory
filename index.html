<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Store Inventory</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
        }

        /* Dashboard Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Form Styling */
        .input-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }

        button#add-btn, button#add-loading-btn {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            transition: background 0.2s;
        }

        button#add-btn:hover, button#add-loading-btn:hover {
            background-color: #1d4ed8;
        }

        /* Table Styling */
        .inventory-list {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8fafc;
            color: #64748b;
        }

        .delete-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn:hover {
            background-color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }

        .search-bar {
            width: 100%;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .qty-input {
            width: 80px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Navigation Tabs */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-radius: 4px;
        }

        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            height: 300px;
        }

        @media print {
            header, .nav-bar, .input-section, .sales-controls, button {
                display: none !important;
            }
            body {
                background-color: white;
                padding: 0;
            }
            .container {
                max-width: 100%;
            }
            th:last-child, td:last-child {
                display: none;
            }
            .inventory-list {
                box-shadow: none;
                padding: 0;
            }
            table {
                font-size: 11px;
                width: 100%;
            }
        }

        /* Login Styles */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>
<body>

<!-- Login Overlay -->
<div id="login-overlay">
    <div class="login-card">
        <h2>Store Inventory Login</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="password-input">Enter Password</label>
                <input type="password" id="password-input" required placeholder="Password">
            </div>
            <button type="submit" style="width: 100%; margin-top: 20px; background-color: var(--primary-color); color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">Login</button>
        </form>
        <p id="login-error" style="color: #ef4444; display: none; margin-top: 15px;">Incorrect password</p>
    </div>
</div>

<div class="container" style="display: none;">
    <header>
        <h1>Store Inventory Manager</h1>
    </header>

    <!-- Navigation -->
    <div class="nav-bar">
        <button class="nav-btn active" id="tab-inventory" onclick="showPage('inventory')">Accessories Inventory</button>
        <button class="nav-btn" id="tab-loadings" onclick="showPage('loadings')">Loading Inventory</button>
        <button class="nav-btn" id="tab-sales" onclick="showPage('sales')">Record Sales</button>
        <button class="nav-btn" id="tab-data" onclick="showPage('data')">Manage Data</button>
        <button class="nav-btn" onclick="logout()" style="margin-left: auto; color: #ef4444;">Logout</button>
    </div>

    <div id="inventory-page">
    <!-- Dashboard Stats -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-title">Total Products</div>
            <div class="stat-number" id="total-products">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Total Inventory Cost</div>
            <div class="stat-number" id="total-cost">₱0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Total Inventory Value</div>
            <div class="stat-number" id="total-value">₱0.00</div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="input-section">
        <h3>Add New Product</h3>
        <form id="inventory-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="product-name">Product Name</label>
                    <input type="text" id="product-name" required placeholder="e.g. Charger">
                </div>
                <div class="form-group">
                    <label for="product-qty">Quantity</label>
                    <input type="number" id="product-qty" min="0" required placeholder="0">
                </div>
                <div class="form-group">
                    <label for="product-cost">Cost (₱)</label>
                    <input type="number" id="product-cost" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="product-price">Price (₱)</label>
                    <input type="number" id="product-price" min="0" step="0.01" required placeholder="0.00">
                </div>
                <button type="submit" id="add-btn">Add to Inventory</button>
            </div>
        </form>
    </div>

    <!-- Inventory Table -->
    <div class="inventory-list">
        <h3>Current Inventory</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="search-input" class="search-bar" placeholder="Search products by name..." style="margin-bottom: 0; flex: 1;">
        </div>
        <table id="inventory-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Quantity</th>
                    <th>Cost</th>
                    <th>Price</th>
                    <th>Total Value</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Rows will be added here by JS -->
            </tbody>
        </table>
        <div id="empty-msg" class="empty-state">No items in inventory yet.</div>
    </div>
    </div> <!-- End Inventory Page -->

    <!-- Loadings Page -->
    <div id="loadings-page" style="display:none;">
        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
            <label for="loadings-date-filter">Filter Stats Date:</label>
            <input type="date" id="loadings-date-filter" class="search-bar" style="width: auto; margin-bottom: 0;">
            <button onclick="document.getElementById('loadings-date-filter').value = ''; updateStats();" style="padding: 8px 12px; cursor: pointer;">Clear</button>
        </div>
        <!-- Loadings Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-title">Total Loading Inventory Sales</div>
                <div class="stat-number" id="loadings-total-sales">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Loading Inventory Profit</div>
                <div class="stat-number" id="loadings-total-profit">₱0.00</div>
            </div>
        </div>

        <div class="input-section">
            <h3>Add New Loading</h3>
            <form id="loadings-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="loading-name">Loading Name</label>
                        <select id="loading-name">
                            <option value="Smart">Smart</option>
                            <option value="Globe">Globe</option>
                            <option value="Dito">Dito</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="loading-balance">Add Amount</label>
                        <input type="number" id="loading-balance" min="0" step="0.01" required placeholder="0.00">
                    </div>
                    <button type="submit" id="add-loading-btn">Add Loading</button>
                </div>
            </form>
        </div>

        <div class="inventory-list">
            <h3>Loading Inventory</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="loadings-search-input" class="search-bar" placeholder="Search loadings..." style="margin-bottom: 0; flex: 1;">
            </div>
            <table id="loadings-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Balance</th>
                        <th>Price</th>
                        <th>Total Value</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="loadings-body">
                    <!-- Rows will be added here by JS -->
                </tbody>
            </table>
            <div id="loadings-empty-msg" class="empty-state">No loadings found.</div>
        </div>
    </div>

    <!-- Sales Page -->
    <div id="sales-page" style="display:none;">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-title" id="sales-period-label">Total Sales (All Time)</div>
                <div class="stat-number" id="total-sales-value">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title" id="cost-period-label">Total Cost (All Time)</div>
                <div class="stat-number" id="total-cost-value">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title" id="profit-period-label">Total Profit (All Time)</div>
                <div class="stat-number" id="total-profit-value">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Accessories Profit</div>
                <div class="stat-number" id="accessories-profit-value">₱0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Loading Inventory Profit</div>
                <div class="stat-number" id="loadings-profit-value">₱0.00</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>

        <div class="input-section">
            <h3>Record New Sale</h3>
            <form id="sales-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="sale-category-select" onchange="populateSalesDropdown()">
                            <option value="">All Categories</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Loadings">Loading Inventory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Select Product</label>
                        <select id="sale-product-id" required>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity Sold</label>
                        <input type="number" id="sale-qty" min="1" required placeholder="1">
                    </div>
                    <button type="submit" id="add-btn">Confirm Sale</button>
                </div>
            </form>
        </div>

        <div class="inventory-list">
            <h3>Daily Sales Log</h3>
            <div class="sales-controls" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <label for="sales-date-filter">Filter Date:</label>
                <input type="date" id="sales-date-filter" class="search-bar" style="width: auto; margin-bottom: 0;">
                <select id="sales-category-filter" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <option value="">All Categories</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Loadings">Loading</option>
                </select>
                <button onclick="document.getElementById('sales-date-filter').value = ''; renderSalesTable();" style="padding: 8px 12px; cursor: pointer;">Clear</button>
                <button onclick="exportToExcel()" style="padding: 8px 12px; cursor: pointer; background-color: #10b981; color: white; border: none; border-radius: 4px; margin-left: auto;">Export to Excel</button>
                <button onclick="window.print()" style="padding: 8px 12px; cursor: pointer; background-color: #6366f1; color: white; border: none; border-radius: 4px;">Print Report</button>
                <button onclick="deleteAllSales()" style="padding: 8px 12px; cursor: pointer; background-color: #ef4444; color: white; border: none; border-radius: 4px;">Delete All</button>
            </div>
            <table id="sales-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Product</th>
                        <th>Qty Sold</th>
                        <th>Total Amount</th>
                        <th>Profit</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="sales-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Data Management Page -->
    <div id="data-page" style="display:none;">
        <div class="input-section" style="text-align: center;">
            <h3>Backup & Restore Data</h3>
            <p>Save your inventory and sales data to a file, or load data from another device.</p>
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <button onclick="exportBackup()" style="background-color: #10b981; color: white; padding: 15px 30px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em;">
                    Download Backup (Save)
                </button>
                <button onclick="document.getElementById('import-file').click()" style="background-color: #f59e0b; color: white; padding: 15px 30px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em;">
                    Restore from File (Load)
                </button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="importBackup(this)">
            </div>
            <p style="margin-top: 20px; color: #6b7280; font-size: 0.9em;">Note: Restoring will overwrite the current data on this device.</p>
        </div>
    </div>
</div>

<script>
    // 1. Initialize State
    let inventory = JSON.parse(localStorage.getItem('storeInventory')) || [];
    let salesLog = JSON.parse(localStorage.getItem('storeSales')) || [];
    let salesChart = null;

    // 2. DOM Elements
    const form = document.getElementById('inventory-form');
    const loadingsForm = document.getElementById('loadings-form');
    const salesForm = document.getElementById('sales-form');
    const tableBody = document.getElementById('table-body');
    const loadingsBody = document.getElementById('loadings-body');
    const salesBody = document.getElementById('sales-body');
    const emptyMsg = document.getElementById('empty-msg');
    const loadingsEmptyMsg = document.getElementById('loadings-empty-msg');
    const totalProductsEl = document.getElementById('total-products');
    const totalValueEl = document.getElementById('total-value');
    const totalCostEl = document.getElementById('total-cost');
    const loadingsTotalSalesEl = document.getElementById('loadings-total-sales');
    const loadingsTotalProfitEl = document.getElementById('loadings-total-profit');

    // 3. Functions

    // Tab Switching
    function showPage(pageId) {
        document.getElementById('inventory-page').style.display = pageId === 'inventory' ? 'block' : 'none';
        document.getElementById('loadings-page').style.display = pageId === 'loadings' ? 'block' : 'none';
        document.getElementById('sales-page').style.display = pageId === 'sales' ? 'block' : 'none';
        document.getElementById('data-page').style.display = pageId === 'data' ? 'block' : 'none';
        
        // Update buttons
        document.getElementById('tab-inventory').classList.toggle('active', pageId === 'inventory');
        document.getElementById('tab-loadings').classList.toggle('active', pageId === 'loadings');
        document.getElementById('tab-sales').classList.toggle('active', pageId === 'sales');
        document.getElementById('tab-data').classList.toggle('active', pageId === 'data');

        if(pageId === 'sales') {
            populateSalesDropdown();
            renderSalesTable();
        }
    }

    // Save to LocalStorage
    function saveData() {
        localStorage.setItem('storeInventory', JSON.stringify(inventory));
        localStorage.setItem('storeSales', JSON.stringify(salesLog));
        renderTable();
        renderLoadingsTable();
        updateStats();
    }

    // Add Product
    function addProduct(e) {
        e.preventDefault();

        const name = document.getElementById('product-name').value;
        const qty = parseInt(document.getElementById('product-qty').value);
        const price = parseFloat(document.getElementById('product-price').value);
        const cost = parseFloat(document.getElementById('product-cost').value) || 0;

        // Check if product exists
        const existingItem = inventory.find(item => item.name.toLowerCase() === name.toLowerCase() && item.category === 'Accessories');

        if (existingItem) {
            existingItem.qty += qty;
            existingItem.price = price;
            existingItem.cost = cost;
            alert(`Updated ${existingItem.name}: Added ${qty} to stock.`);
        } else {
            const newProduct = {
                id: Date.now(), // Simple unique ID based on timestamp
                name,
                category: 'Accessories',
                qty,
                price,
                cost
            };
            inventory.push(newProduct);
        }
        saveData();
        form.reset();
    }

    // Add Loading
    function addLoading(e) {
        e.preventDefault();

        const name = document.getElementById('loading-name').value;
        const balance = parseFloat(document.getElementById('loading-balance').value);
        const price = 1;

        // Check if loading exists
        const existingItem = inventory.find(item => item.name.toLowerCase() === name.toLowerCase() && item.category === 'Loadings');

        if (existingItem) {
            existingItem.qty += balance;
            existingItem.price = price;
            alert(`Updated ${existingItem.name}: Added ₱${balance} to balance.`);
        } else {
            const newProduct = {
                id: Date.now(),
                name,
                category: 'Loadings',
                qty: balance, // Using qty to store Balance for Loadings
                price,
                cost: 0
            };
            inventory.push(newProduct);
        }
        saveData();
        loadingsForm.reset();
    }

    // Update Quantity
    function updateQuantity(id, newQty) {
        const qty = parseInt(newQty);
        if (isNaN(qty) || qty < 0) {
            alert('Please enter a valid quantity');
            renderTable(); // Reset to original value
            return;
        }
        const item = inventory.find(i => i.id === id);
        if (item) {
            item.qty = qty;
            saveData();
        }
    }

    // Update Cost
    function updateCost(id, newCost) {
        const cost = parseFloat(newCost);
        if (isNaN(cost) || cost < 0) {
            alert('Please enter a valid cost');
            renderTable(); // Reset to original value
            return;
        }
        const item = inventory.find(i => i.id === id);
        if (item) {
            item.cost = cost;
            saveData();
        }
    }

    // Update Balance (for Loadings)
    function updateBalance(id, newBalance) {
        const balance = parseFloat(newBalance);
        if (isNaN(balance) || balance < 0) {
            alert('Please enter a valid balance');
            renderLoadingsTable();
            return;
        }
        const item = inventory.find(i => i.id === id);
        if (item) {
            item.qty = balance;
            saveData();
        }
    }

    // Populate Sales Dropdown
    function populateSalesDropdown() {
        const select = document.getElementById('sale-product-id');
        const categorySelect = document.getElementById('sale-category-select');
        const selectedCategory = categorySelect ? categorySelect.value : '';

        select.innerHTML = '<option value="">-- Select Product --</option>';
        inventory.forEach(item => {
            const categoryMatch = selectedCategory === '' || item.category === selectedCategory;
            const isAvailable = item.qty > 0 || item.category === 'Loadings';

            if(categoryMatch && isAvailable) {
                const option = document.createElement('option');
                option.value = item.id;
                if (item.category === 'Loadings') {
                    option.textContent = `${item.name} (Bal: ₱${item.qty.toLocaleString()}) - ₱${item.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                } else {
                    option.textContent = `${item.name} (Stock: ${item.qty.toLocaleString()}) - ₱${item.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                select.appendChild(option);
            }
        });
    }

    // Record Sale
    function recordSale(e) {
        e.preventDefault();
        const productId = parseInt(document.getElementById('sale-product-id').value);
        const qtySold = parseInt(document.getElementById('sale-qty').value);
        
        const productIndex = inventory.findIndex(p => p.id === productId);
        
        if (productIndex > -1) {
            const product = inventory[productIndex];
            const isLoading = product.category === 'Loadings';
            const itemPrice = product.price;
            const totalSaleAmount = qtySold * itemPrice;
            
            // Check stock/balance
            if (isLoading) {
                if (product.qty < totalSaleAmount) {
                    alert('Insufficient load balance! Current balance: ₱' + product.qty.toFixed(2));
                    return;
                }
                product.qty -= totalSaleAmount;
            } else {
                if (product.qty < qtySold) {
                    alert('Insufficient stock! Current stock: ' + product.qty);
                    return;
                }
                product.qty -= qtySold;
            }

            const itemCost = product.cost || 0;
            
            // Calculate Profit
            let profit = 0;
            if (isLoading) {
                // For Loadings: Profit is 2% of the total amount (Price * Qty)
                profit = totalSaleAmount * 0.02;
            } else {
                profit = qtySold * (itemPrice - itemCost);
            }

                // 2. Record Sale
                const now = new Date();
                const saleRecord = {
                    id: Date.now(),
                    date: now.toLocaleDateString(),
                    time: now.toLocaleTimeString(),
                    productName: inventory[productIndex].name,
                    category: inventory[productIndex].category,
                    qty: qtySold,
                    total: qtySold * itemPrice,
                    profit: profit
                };
                
                salesLog.unshift(saleRecord); // Add to top of list
                saveData(); // Saves both inventory and sales
                
                // 3. Reset Form
                alert('Sale recorded! Inventory updated.');
                salesForm.reset();
                populateSalesDropdown();
                renderSalesTable();
        }
    }

    // Delete All Sales
    function deleteAllSales() {
        if(confirm("WARNING: You are about to delete ALL sales records.\n\nThis action cannot be undone and will NOT restore inventory quantities.\n\nAre you sure you want to proceed?")) {
            salesLog = [];
            saveData();
            renderSalesTable();
            alert("All sales records have been deleted.");
        }
    }

    // Delete Sale (Undo)
    function deleteSale(id) {
        if(confirm('Are you sure you want to remove this sale? This will restore the stock quantity.')) {
            const sale = salesLog.find(s => s.id === id);
            if(sale) {
                // Restore stock
                const product = inventory.find(p => p.name === sale.productName);
                if(product && product.category !== 'Loadings') {
                    if (product.category === 'Loadings') {
                        product.qty += sale.total;
                    } else {
                        product.qty += sale.qty;
                    }
                }
                
                // Remove from log
                salesLog = salesLog.filter(s => s.id !== id);
                saveData();
                renderSalesTable();
                populateSalesDropdown();
            }
        }
    }

    // Delete Product
    function deleteProduct(id) {
        if(confirm('Are you sure you want to delete this item?')) {
            inventory = inventory.filter(item => item.id !== id);
            saveData();
        }
    }

    // Update Dashboard Stats
    function updateStats() {
        // Filter only Accessories for the dashboard stats
        const accessories = inventory.filter(item => item.category === 'Accessories');

        const totalQty = accessories.reduce((sum, item) => sum + item.qty, 0);
        const totalVal = accessories.reduce((sum, item) => sum + (item.qty * item.price), 0);
        const totalCost = accessories.reduce((sum, item) => sum + (item.qty * (item.cost || 0)), 0);

        totalProductsEl.textContent = totalQty.toLocaleString();
        totalValueEl.textContent = '₱' + totalVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        totalCostEl.textContent = '₱' + totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Calculate Loadings Stats
        let loadingsSales = 0;
        let loadingsProfit = 0;
        
        const loadingsFilterInput = document.getElementById('loadings-date-filter');
        const filterDate = loadingsFilterInput ? loadingsFilterInput.value : '';
        let filterDateStr = '';

        // Update Titles based on filter
        const salesTitle = document.querySelector('#loadings-total-sales').previousElementSibling;
        const profitTitle = document.querySelector('#loadings-total-profit').previousElementSibling;

        if (filterDate) {
            const [y, m, d] = filterDate.split('-');
            filterDateStr = new Date(y, m - 1, d).toLocaleDateString();
            if(salesTitle) salesTitle.textContent = `Total Loading Inventory Sales (${filterDateStr})`;
            if(profitTitle) profitTitle.textContent = `Total Loading Inventory Profit (${filterDateStr})`;
        } else {
            if(salesTitle) salesTitle.textContent = `Total Loading Inventory Sales (All Time)`;
            if(profitTitle) profitTitle.textContent = `Total Loading Inventory Profit (All Time)`;
        }

        salesLog.forEach(sale => {
            let saleCat = sale.category;
            // Backwards compatibility for older sales records
            if (!saleCat) {
                const p = inventory.find(i => i.name === sale.productName);
                if (p) saleCat = p.category;
            }
            if (saleCat === 'Loadings') {
                if (filterDate && sale.date !== filterDateStr) {
                    return;
                }
                loadingsSales += sale.total;
                loadingsProfit += (sale.profit || 0);
            }
        });

        if(loadingsTotalSalesEl) loadingsTotalSalesEl.textContent = '₱' + loadingsSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if(loadingsTotalProfitEl) loadingsTotalProfitEl.textContent = '₱' + loadingsProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Render Table
    function renderTable() {
        tableBody.innerHTML = '';
        const searchTerm = document.getElementById('search-input').value.toLowerCase();

        // Filter for Accessories Inventory
        const filteredInventory = inventory.filter(item => {
            return item.category === 'Accessories' && item.name.toLowerCase().includes(searchTerm);
        });

        if (filteredInventory.length === 0) {
            emptyMsg.style.display = 'block';
            if (inventory.length > 0) {
                emptyMsg.textContent = 'No matching products found.';
            } else {
                emptyMsg.textContent = 'No items in inventory yet.';
            }
        } else {
            emptyMsg.style.display = 'none';
            
            filteredInventory.forEach(item => {
                const row = document.createElement('tr');
                const itemTotal = (item.qty * item.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty.toLocaleString()}</td>
                    <td>₱<input type="number" class="qty-input" value="${item.cost || 0}" min="0" step="0.01" onchange="updateCost(${item.id}, this.value)"></td>
                    <td>₱${item.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>₱${itemTotal}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteProduct(${item.id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
    }

    // Render Loadings Table
    function renderLoadingsTable() {
        loadingsBody.innerHTML = '';
        const searchTerm = document.getElementById('loadings-search-input').value.toLowerCase();

        // Filter for Loadings Only
        const filteredLoadings = inventory.filter(item => {
            const matchesName = item.name.toLowerCase().includes(searchTerm);
            const isLoading = item.category === 'Loadings';
            return matchesName && isLoading;
        });

        if (filteredLoadings.length === 0) {
            loadingsEmptyMsg.style.display = 'block';
        } else {
            loadingsEmptyMsg.style.display = 'none';
            
            filteredLoadings.forEach(item => {
                const row = document.createElement('tr');
                const itemTotal = (item.qty * item.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td><span style="background:#e0f2fe; color:#0369a1; padding: 2px 8px; border-radius:12px; font-size:0.85em;">${item.category}</span></td>
                    <td>₱<input type="number" class="qty-input" value="${item.qty}" min="0" step="0.01" onchange="updateBalance(${item.id}, this.value)"></td>
                    <td>₱${item.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>₱${itemTotal}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteProduct(${item.id})">Delete</button>
                    </td>
                `;
                loadingsBody.appendChild(row);
            });
        }
    }

    // Render Sales Table
    function renderSalesTable() {
        salesBody.innerHTML = '';
        
        const filterInput = document.getElementById('sales-date-filter').value;
        const categoryFilter = document.getElementById('sales-category-filter').value;
        let displayLog = salesLog;
        const label = document.getElementById('sales-period-label');
        const profitLabel = document.getElementById('profit-period-label');
        const costLabel = document.getElementById('cost-period-label');

        // Filter by Category
        if (categoryFilter) {
            displayLog = displayLog.filter(sale => {
                let saleCat = sale.category;
                // Backwards compatibility: try to find category in inventory if not saved in sale
                if (!saleCat) {
                    const p = inventory.find(i => i.name === sale.productName);
                    if (p) saleCat = p.category;
                }
                return saleCat === categoryFilter;
            });
        }

        if (filterInput) {
            const [y, m, d] = filterInput.split('-');
            const filterDateStr = new Date(y, m - 1, d).toLocaleDateString();
            displayLog = displayLog.filter(sale => sale.time && sale.date === filterDateStr);
            label.textContent = `Total Sales (${filterDateStr})`;
            costLabel.textContent = `Total Cost (${filterDateStr})`;
            profitLabel.textContent = `Total Profit (${filterDateStr})`;
        } else {
            label.textContent = 'Total Sales (All Time)';
            costLabel.textContent = 'Total Cost (All Time)';
            profitLabel.textContent = 'Total Profit (All Time)';
        }

        updateChart(displayLog);
        let totalSales = 0;
        let totalCost = 0;
        let totalProfit = 0;
        let accessoriesProfit = 0;
        let loadingsProfit = 0;
        
        displayLog.forEach(sale => {
            const row = document.createElement('tr');
            // Handle legacy data where 'date' stored the time
            const dateDisplay = sale.time ? sale.date : '-';
            const timeDisplay = sale.time ? sale.time : sale.date;

            row.innerHTML = `
                <td>${dateDisplay}</td>
                <td>${timeDisplay}</td>
                <td>${sale.productName}</td>
                <td>${sale.qty.toLocaleString()}</td>
                <td>₱${sale.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>₱${(sale.profit || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td><button class="delete-btn" onclick="deleteSale(${sale.id})">Undo</button></td>
            `;
            salesBody.appendChild(row);
            totalSales += sale.total;
            totalCost += (sale.total - (sale.profit || 0));
            totalProfit += (sale.profit || 0);

            // Calculate breakdown
            let saleCat = sale.category;
            if (!saleCat) {
                const p = inventory.find(i => i.name === sale.productName);
                if (p) saleCat = p.category;
            }
            if (saleCat === 'Accessories') {
                accessoriesProfit += (sale.profit || 0);
            } else if (saleCat === 'Loadings') {
                loadingsProfit += (sale.profit || 0);
            }
        });
        document.getElementById('total-sales-value').textContent = '₱' + totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('total-cost-value').textContent = '₱' + totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('total-profit-value').textContent = '₱' + totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('accessories-profit-value').textContent = '₱' + accessoriesProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('loadings-profit-value').textContent = '₱' + loadingsProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Update Chart
    function updateChart(data) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        // Aggregate data by product
        const productTotals = {};
        data.forEach(sale => {
            if (productTotals[sale.productName]) {
                productTotals[sale.productName] += sale.total;
            } else {
                productTotals[sale.productName] = sale.total;
            }
        });

        if (salesChart) {
            salesChart.destroy();
        }

        salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(productTotals),
                datasets: [{
                    label: 'Revenue (₱)',
                    data: Object.values(productTotals),
                    backgroundColor: '#2563eb',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Export to Excel (CSV)
    function exportToExcel() {
        const filterInput = document.getElementById('sales-date-filter').value;
        let dataToExport = salesLog;
        let filename = 'sales_report_all_time.csv';

        if (filterInput) {
            const [y, m, d] = filterInput.split('-');
            const filterDateStr = new Date(y, m - 1, d).toLocaleDateString();
            dataToExport = salesLog.filter(sale => sale.time && sale.date === filterDateStr);
            filename = `sales_report_${filterInput}.csv`;
        }

        if (dataToExport.length === 0) {
            alert('No data to export');
            return;
        }

        const headers = ["Date", "Time", "Product Name", "Quantity Sold", "Total Amount", "Profit"];
        const rows = dataToExport.map(row => {
            const dateDisplay = row.time ? row.date : '-';
            const timeDisplay = row.time ? row.time : row.date;
            const profit = row.profit || 0;
            const cleanName = `"${row.productName.replace(/"/g, '""')}"`; // Escape quotes
            
            return [dateDisplay, timeDisplay, cleanName, row.qty, row.total.toFixed(2), profit.toFixed(2)].join(",");
        });

        const csvContent = "\uFEFF" + [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Backup Data
    function exportBackup() {
        const data = {
            inventory: inventory,
            salesLog: salesLog
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", url);
        downloadAnchorNode.setAttribute("download", "store_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        URL.revokeObjectURL(url);
    }

    // Restore Data
    function importBackup(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.inventory && data.salesLog) {
                    if(confirm("This will overwrite your current data. Are you sure?")) {
                        inventory = data.inventory;
                        salesLog = data.salesLog;
                        saveData();
                        alert("Data restored successfully!");
                        location.reload();
                    }
                } else {
                    alert("Invalid backup file.");
                }
            } catch (err) {
                alert("Error reading file.");
            }
        };
        reader.readAsText(file);
    }

    // Login Logic
    const loginForm = document.getElementById('login-form');
    const loginOverlay = document.getElementById('login-overlay');
    const mainContainer = document.querySelector('.container');
    const loginError = document.getElementById('login-error');
    const APP_PASSWORD = "geecalderon"; // CHANGE THIS PASSWORD

    // Check session storage
    if (sessionStorage.getItem('isLoggedIn') === 'true') {
        loginOverlay.style.display = 'none';
        mainContainer.style.display = 'block';
    }

    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const passwordInput = document.getElementById('password-input').value;
        
        if (passwordInput === APP_PASSWORD) {
            sessionStorage.setItem('isLoggedIn', 'true');
            loginOverlay.style.display = 'none';
            mainContainer.style.display = 'block';
        } else {
            loginError.style.display = 'block';
        }
    });

    // Logout Function
    function logout() {
        sessionStorage.removeItem('isLoggedIn');
        location.reload();
    }

    // 4. Event Listeners
    form.addEventListener('submit', addProduct);
    loadingsForm.addEventListener('submit', addLoading);
    salesForm.addEventListener('submit', recordSale);
    document.getElementById('search-input').addEventListener('input', renderTable);
    document.getElementById('loadings-search-input').addEventListener('input', renderLoadingsTable);
    document.getElementById('sales-date-filter').addEventListener('change', renderSalesTable);
    document.getElementById('sales-category-filter').addEventListener('change', renderSalesTable);
    document.getElementById('loadings-date-filter').addEventListener('change', updateStats);

    // 5. Initial Load
    renderTable();
    renderLoadingsTable();
    updateStats();

</script>

</body>
</html>
